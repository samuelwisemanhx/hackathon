# Story 1.6: Basic Application Shell and Protected Routes

## Status
Draft

## Story
**As a** logged-in user,
**I want** a consistent application layout with navigation and route protection,
**so that** I have a clear way to navigate the application and my session is secure.

## Acceptance Criteria

1. Layout component includes header with app branding and user menu (when logged in)
2. User menu shows current user email and logout option
3. Protected routes (e.g., `/dashboard`, `/assessment`) redirect to `/login` if user is not authenticated
4. Session validation happens server-side using SvelteKit load functions
5. `/dashboard` page exists as placeholder landing page after login showing "Assessment Dashboard" heading
6. Logout functionality clears session and redirects to login page
7. Navigation is responsive and works on mobile devices
8. Basic loading states shown during authentication checks

## Tasks / Subtasks

- [ ] Create root layout with header (AC: 1, 2, 7)
  - [ ] Create `src/routes/+layout.svelte`
  - [ ] Create Header component with app branding
  - [ ] Add user menu (conditional on logged-in state)
  - [ ] Show user email in menu
  - [ ] Add logout button
  - [ ] Make header responsive for mobile

- [ ] Implement server-side authentication (AC: 3, 4)
  - [ ] Create `src/routes/+layout.server.ts`
  - [ ] Load user from event.locals (set by hooks.server.ts)
  - [ ] Pass user data to layout
  - [ ] Create `src/routes/dashboard/+page.server.ts` to protect route

- [ ] Create dashboard page (AC: 5)
  - [ ] Create `src/routes/dashboard/+page.svelte`
  - [ ] Display "Assessment Dashboard" heading
  - [ ] Add placeholder content
  - [ ] Verify authentication required

- [ ] Implement logout functionality (AC: 6)
  - [ ] Create `src/routes/logout/+page.server.ts` with form action
  - [ ] Call logout API endpoint
  - [ ] Clear session cookie
  - [ ] Redirect to login page

- [ ] Add loading states (AC: 8)
  - [ ] Create LoadingSpinner component
  - [ ] Show spinner during navigation
  - [ ] Show spinner during auth checks

- [ ] Write tests
  - [ ] Test protected routes redirect unauthenticated users
  - [ ] Test authenticated users see user menu
  - [ ] Test logout clears session
  - [ ] Test mobile responsive layout

## Dev Notes

### Previous Story Insights
[Source: Story 1.4, 1.5]
- Session middleware in hooks.server.ts sets event.locals.user
- Protected routes should check event.locals.user
- Logout endpoint: POST `/api/auth/logout`

### Layout Architecture
[Source: architecture/frontend-architecture.md#routing-structure]

**SvelteKit Layout Pattern:**
- `+layout.svelte` - UI layout (rendered on client)
- `+layout.server.ts` - Server load function (runs before page)
- Data flows from layout.server → layout → page

### Root Layout Implementation

```svelte
<!-- src/routes/+layout.svelte -->
<script lang="ts">
  import Header from '$lib/components/layout/Header.svelte';
  import { page } from '$app/stores';

  // Data from +layout.server.ts
  const { data, children } = $props();
</script>

<div class="min-h-screen bg-gray-50">
  {#if data.user}
    <Header user={data.user} />
  {/if}

  <main>
    {@render children()}
  </main>
</div>
```

```typescript
// src/routes/+layout.server.ts
import type { LayoutServerLoad } from './$types';

export const load: LayoutServerLoad = async ({ locals }) => {
  return {
    user: locals.user || null
  };
};
```

### Header Component

```svelte
<!-- src/lib/components/layout/Header.svelte -->
<script lang="ts">
  import type { User } from '$lib/types';

  type Props = {
    user: User;
  };

  let { user }: Props = $props();
  let showMenu = $state(false);
</script>

<header class="bg-white shadow">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">AI Skills Assessment</h1>

    <div class="relative">
      <button
        onclick={() => showMenu = !showMenu}
        class="flex items-center gap-2"
      >
        {user.email}
        <svg><!-- dropdown icon --></svg>
      </button>

      {#if showMenu}
        <div class="absolute right-0 mt-2 bg-white shadow rounded">
          <form method="POST" action="/logout">
            <button type="submit" class="block px-4 py-2">
              Logout
            </button>
          </form>
        </div>
      {/if}
    </div>
  </div>
</header>
```

### Protected Route Pattern

**Option 1: Server Load Function (Recommended)**
```typescript
// src/routes/dashboard/+page.server.ts
import { redirect } from '@sveltejs/kit';
import type { PageServerLoad } from './$types';

export const load: PageServerLoad = async ({ locals }) => {
  if (!locals.user) {
    throw redirect(303, '/login');
  }

  return {
    // Page data
  };
};
```

**Option 2: Hooks (Already Implemented in Story 1.4)**
The session middleware in `hooks.server.ts` can handle global redirects for protected routes.

### Dashboard Page

```svelte
<!-- src/routes/dashboard/+page.svelte -->
<script lang="ts">
  const { data } = $props();
</script>

<div class="container mx-auto py-8">
  <h1 class="text-3xl font-bold mb-6">Assessment Dashboard</h1>

  <p class="text-gray-600">
    Welcome! Your assessment management will appear here.
  </p>

  <!-- Placeholder for future stories -->
</div>
```

### Logout Implementation

```typescript
// src/routes/logout/+page.server.ts
import { redirect } from '@sveltejs/kit';
import type { Actions } from './$types';

export const actions: Actions = {
  default: async ({ cookies, fetch }) => {
    // Call logout API
    await fetch('/api/auth/logout', { method: 'POST' });

    // Clear cookie
    cookies.delete('session_token', { path: '/' });

    // Redirect to login
    throw redirect(303, '/login');
  }
};
```

### Component Organization
[Source: architecture/frontend-architecture.md#component-organization]

**Files to Create:**
- `src/lib/components/layout/Header.svelte`
- `src/lib/components/layout/LoadingSpinner.svelte`
- `src/routes/+layout.svelte`
- `src/routes/+layout.server.ts`
- `src/routes/dashboard/+page.svelte`
- `src/routes/dashboard/+page.server.ts`
- `src/routes/logout/+page.server.ts`

### Mobile Responsiveness
[Source: architecture/tech-stack.md]

**Responsive Header:**
- Desktop: Full menu visible
- Mobile: Hamburger menu or simple dropdown
- Use Tailwind breakpoints: `md:`, `lg:`
- Test on 320px, 768px, 1024px viewports

### Loading States
[Source: architecture/frontend-architecture.md]

**SvelteKit Navigation:**
- Use `$page.state` to detect navigation
- Show global loading indicator during route changes
- Use `loading` prop on components

**LoadingSpinner Component:**
```svelte
<!-- src/lib/components/layout/LoadingSpinner.svelte -->
<div class="flex justify-center items-center p-8">
  <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
</div>
```

### Type Definitions
[Source: architecture/coding-standards.md#critical-fullstack-rules]

**App Type Definitions (from Story 1.4):**
```typescript
// src/app.d.ts
import type { User, Session } from '$lib/types';

declare global {
  namespace App {
    interface Locals {
      user?: User;
      session?: Session;
    }
    interface PageData {
      user?: User | null;
    }
  }
}

export {};
```

### Testing
[Source: architecture/tech-stack.md]

**Test Files:**
- `tests/e2e/protected-routes.spec.ts` (Playwright)
- `tests/components/Header.test.ts` (Vitest)
- `tests/components/Layout.test.ts` (Vitest)

**E2E Test Scenarios:**
1. Unauthenticated user accessing /dashboard redirects to /login
2. Authenticated user sees header with email
3. Logout button clears session and redirects
4. Mobile menu works correctly

**Component Test Scenarios:**
1. Header shows user email
2. Logout form submits correctly
3. Mobile menu toggle works
4. Loading spinner displays

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
