# Story 1.2: User Database Schema

## Status
Draft

## Story
**As a** developer,
**I want** database schema defined for users and sessions,
**so that** I can store user accounts and manage authentication state.

## Acceptance Criteria

1. Users table created with fields: id (UUID), email (unique), password_hash, created_at, updated_at
2. Sessions table created with fields: id, user_id (foreign key), token (unique), expires_at, created_at
3. Database indexes added on email (users) and token (sessions) for query performance
4. Drizzle schema types are exported for use in application code
5. Migration script successfully creates tables in database
6. Schema includes appropriate constraints (NOT NULL, UNIQUE, foreign keys)

## Tasks / Subtasks

- [ ] Create users table schema in Drizzle (AC: 1, 3, 4, 6)
  - [ ] Define users table with id, email, password_hash, createdAt, updatedAt fields
  - [ ] Add UUID primary key with default random generation
  - [ ] Add unique constraint on email field
  - [ ] Add NOT NULL constraints appropriately
  - [ ] Create index on email field for query performance
  - [ ] Export schema for TypeScript type inference

- [ ] Create sessions table schema in Drizzle (AC: 2, 3, 4, 6)
  - [ ] Define sessions table with id, userId, token, expiresAt, createdAt fields
  - [ ] Add UUID primary key with default random generation
  - [ ] Add foreign key reference to users.id with cascade delete
  - [ ] Add unique constraint on token field
  - [ ] Add NOT NULL constraints appropriately
  - [ ] Create index on token field for query performance
  - [ ] Export schema for TypeScript type inference

- [ ] Export TypeScript types (AC: 4)
  - [ ] Verify Drizzle generates proper TypeScript types from schema
  - [ ] Create type exports for User and Session models
  - [ ] Document how to import and use types in application code

- [ ] Generate and run migration (AC: 5, 6)
  - [ ] Run `drizzle-kit generate:pg` to create migration SQL
  - [ ] Review generated SQL for correctness
  - [ ] Run migration against local database
  - [ ] Verify tables created successfully with correct schema
  - [ ] Verify all constraints and indexes are present

- [ ] Create unit tests for schema
  - [ ] Test user creation with valid data
  - [ ] Test email uniqueness constraint
  - [ ] Test foreign key relationship between sessions and users
  - [ ] Test cascade delete behavior (deleting user removes sessions)
  - [ ] Test token uniqueness constraint

## Dev Notes

### CRITICAL ARCHITECTURAL CONFLICT

**⚠️ IMPORTANT:** There is a discrepancy between the epic acceptance criteria and the current architecture:

**Epic AC says:** Create sessions table with password_hash in users table (traditional session-based auth)

**Architecture says:** [Source: architecture/tech-stack.md]
- "Authentication | Email-only (MVP) | - | Temporary user identification | Simplified for MVP - no passwords, no sessions, just email in cookie. Production auth post-MVP."

**Resolution Guidance:**
The developer should implement EXACTLY what the acceptance criteria specify (users + sessions tables with password_hash). However, this architectural conflict should be flagged to the Product Owner after implementation. The architecture documentation may need updating to reflect the session-based approach, OR the epic may need revision to align with simplified email-only MVP auth.

For now: **FOLLOW THE EPIC ACCEPTANCE CRITERIA** - implement the full session-based schema as specified.

### Previous Story Insights
[Source: Story 1.1]
- Database connection and Drizzle ORM are configured
- Drizzle Kit is set up for migrations
- Schema file location: `src/lib/server/db/schema.ts`
- Migration command: `drizzle-kit generate:pg`
- Database configuration uses PostgreSQL with connection pooling

### Database Schema Requirements
[Source: architecture/database-schema.md]

**Users Table Structure:**
```typescript
export const users = pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull()
});
```

**NOTE:** Architecture shows users WITHOUT password_hash field. Epic AC requires password_hash - add this field per AC requirements.

**Sessions Table:** Not present in current architecture documentation but required by epic AC. Implement as specified in AC.

**Required Drizzle Imports:**
```typescript
import { pgTable, uuid, varchar, timestamp, text, index } from 'drizzle-orm/pg-core';
```

### Data Models
[Source: architecture/data-models.md#user]

**User Type Interface:**
```typescript
export interface User {
  id: string;
  email: string;
  createdAt: Date;
  updatedAt: Date;
}
```

**NOTE:** Add password_hash field to match AC requirements.

**Session Type Interface (create new):**
```typescript
export interface Session {
  id: string;
  userId: string;
  token: string;
  expiresAt: Date;
  createdAt: Date;
}
```

### Project Structure
[Source: architecture/unified-project-structure.md]

**Schema Location:** `src/lib/server/db/schema.ts`
**Types Location:** `src/lib/types/index.ts` (for shared TypeScript types)
**Migrations Location:** `drizzle/migrations/` (auto-generated)

### Coding Standards
[Source: architecture/coding-standards.md#naming-conventions]

**Naming Conventions:**
- Database Tables: snake_case (users, sessions)
- Database Columns: snake_case (user_id, created_at, expires_at)
- TypeScript Types: PascalCase (User, Session)
- TypeScript Fields: camelCase (userId, createdAt, expiresAt)

**Type Sharing Rule:**
- Always define types in `src/lib/types/` and import
- NEVER duplicate type definitions
- Export Drizzle-inferred types for database operations

### Migration Best Practices

**Migration Workflow:**
1. Update `src/lib/server/db/schema.ts`
2. Run `npm run db:generate` (or `drizzle-kit generate:pg`)
3. Review generated SQL in `drizzle/migrations/`
4. Run `npm run db:migrate` (or `drizzle-kit push:pg` for dev)
5. Verify schema with database client

**Migration Safety:**
- Always review generated SQL before running
- Test migrations on local database first
- Keep migration files in version control
- Never manually edit migration files after generation

### Schema Implementation Details

**Users Table Complete Definition:**
```typescript
export const users = pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  passwordHash: varchar('password_hash', { length: 255 }).notNull(), // Add per AC
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull()
}, (table) => ({
  emailIdx: index('users_email_idx').on(table.email)
}));
```

**Sessions Table Complete Definition:**
```typescript
export const sessions = pgTable('sessions', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  token: varchar('token', { length: 255 }).notNull().unique(),
  expiresAt: timestamp('expires_at').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull()
}, (table) => ({
  tokenIdx: index('sessions_token_idx').on(table.token)
}));
```

**Type Exports:**
```typescript
// Infer types from schema
export type User = typeof users.$inferSelect;
export type NewUser = typeof users.$inferInsert;
export type Session = typeof sessions.$inferSelect;
export type NewSession = typeof sessions.$inferInsert;
```

### Constraints and Indexes Summary

**Users Table:**
- Primary Key: id (UUID)
- Unique Constraint: email
- Index: email (for login queries)
- NOT NULL: id, email, password_hash, created_at, updated_at

**Sessions Table:**
- Primary Key: id (UUID)
- Unique Constraint: token
- Foreign Key: user_id → users.id (CASCADE DELETE)
- Index: token (for session validation queries)
- NOT NULL: id, user_id, token, expires_at, created_at

**Cascade Delete Behavior:**
When a user is deleted, all associated sessions are automatically deleted due to `onDelete: 'cascade'` constraint.

### Testing

**Testing Standards:**
[Source: architecture/tech-stack.md]

**Framework:** Vitest
**Test Location:** `tests/db/schema.test.ts`

**Test Requirements:**
1. **User Creation Test:**
   - Insert user with valid email and password_hash
   - Verify user is created with auto-generated UUID
   - Verify timestamps are auto-populated

2. **Email Uniqueness Test:**
   - Attempt to create two users with same email
   - Verify second insert fails with unique constraint error

3. **Session Creation Test:**
   - Create user, then create session for that user
   - Verify foreign key relationship works
   - Verify session token is unique

4. **Cascade Delete Test:**
   - Create user with multiple sessions
   - Delete user
   - Verify all sessions are automatically deleted

5. **Index Performance Test (optional):**
   - Verify indexes exist on email and token fields
   - Can query pg_indexes to confirm

**Testing Pattern:**
```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { db } from '$lib/server/db';
import { users, sessions } from '$lib/server/db/schema';
import { eq } from 'drizzle-orm';

describe('Database Schema', () => {
  // Setup/teardown for test data
  // Tests for each AC requirement
});
```

### Database Migration Verification

After running migration, verify with SQL:
```sql
-- Check users table
\d users

-- Check sessions table
\d sessions

-- Check indexes
\di users_email_idx
\di sessions_token_idx

-- Check foreign key constraints
SELECT * FROM information_schema.table_constraints
WHERE table_name IN ('users', 'sessions');
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
