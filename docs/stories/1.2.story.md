# Story 1.2: User Database Schema

## Status
Ready for Review

## Story
**As a** developer,
**I want** database schema defined for users and sessions,
**so that** I can store user accounts and manage authentication state.

## Acceptance Criteria

1. Users table created with fields: id (UUID), email (unique), password_hash, created_at, updated_at
2. Sessions table created with fields: id, user_id (foreign key), token (unique), expires_at, created_at
3. Database indexes added on email (users) and token (sessions) for query performance
4. Drizzle schema types are exported for use in application code
5. Migration script successfully creates tables in database
6. Schema includes appropriate constraints (NOT NULL, UNIQUE, foreign keys)

## Tasks / Subtasks

- [x] Create users table schema in Drizzle (AC: 1, 3, 4, 6)
  - [x] Define users table with id, email, password_hash, createdAt, updatedAt fields
  - [x] Add UUID primary key with default random generation
  - [x] Add unique constraint on email field
  - [x] Add NOT NULL constraints appropriately
  - [x] Create index on email field for query performance
  - [x] Export schema for TypeScript type inference

- [x] Create sessions table schema in Drizzle (AC: 2, 3, 4, 6)
  - [x] Define sessions table with id, userId, token, expiresAt, createdAt fields
  - [x] Add UUID primary key with default random generation
  - [x] Add foreign key reference to users.id with cascade delete
  - [x] Add unique constraint on token field
  - [x] Add NOT NULL constraints appropriately
  - [x] Create index on token field for query performance
  - [x] Export schema for TypeScript type inference

- [x] Export TypeScript types (AC: 4)
  - [x] Verify Drizzle generates proper TypeScript types from schema
  - [x] Create type exports for User and Session models
  - [x] Document how to import and use types in application code

- [x] Generate and run migration (AC: 5, 6)
  - [x] Run `drizzle-kit generate:pg` to create migration SQL
  - [x] Review generated SQL for correctness
  - [x] Run migration against local database
  - [x] Verify tables created successfully with correct schema
  - [x] Verify all constraints and indexes are present

- [x] Create unit tests for schema
  - [x] Test user creation with valid data
  - [x] Test email uniqueness constraint
  - [x] Test foreign key relationship between sessions and users
  - [x] Test cascade delete behavior (deleting user removes sessions)
  - [x] Test token uniqueness constraint

## Dev Notes

### CRITICAL ARCHITECTURAL CONFLICT

**⚠️ IMPORTANT:** There is a discrepancy between the epic acceptance criteria and the current architecture:

**Epic AC says:** Create sessions table with password_hash in users table (traditional session-based auth)

**Architecture says:** [Source: architecture/tech-stack.md]
- "Authentication | Email-only (MVP) | - | Temporary user identification | Simplified for MVP - no passwords, no sessions, just email in cookie. Production auth post-MVP."

**Resolution Guidance:**
The developer should implement EXACTLY what the acceptance criteria specify (users + sessions tables with password_hash). However, this architectural conflict should be flagged to the Product Owner after implementation. The architecture documentation may need updating to reflect the session-based approach, OR the epic may need revision to align with simplified email-only MVP auth.

For now: **FOLLOW THE EPIC ACCEPTANCE CRITERIA** - implement the full session-based schema as specified.

### Previous Story Insights
[Source: Story 1.1]
- Database connection and Drizzle ORM are configured
- Drizzle Kit is set up for migrations
- Schema file location: `src/lib/server/db/schema.ts`
- Migration command: `drizzle-kit generate:pg`
- Database configuration uses PostgreSQL with connection pooling

### Database Schema Requirements
[Source: architecture/database-schema.md]

**Users Table Structure:**
```typescript
export const users = pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull()
});
```

**NOTE:** Architecture shows users WITHOUT password_hash field. Epic AC requires password_hash - add this field per AC requirements.

**Sessions Table:** Not present in current architecture documentation but required by epic AC. Implement as specified in AC.

**Required Drizzle Imports:**
```typescript
import { pgTable, uuid, varchar, timestamp, text, index } from 'drizzle-orm/pg-core';
```

### Data Models
[Source: architecture/data-models.md#user]

**User Type Interface:**
```typescript
export interface User {
  id: string;
  email: string;
  createdAt: Date;
  updatedAt: Date;
}
```

**NOTE:** Add password_hash field to match AC requirements.

**Session Type Interface (create new):**
```typescript
export interface Session {
  id: string;
  userId: string;
  token: string;
  expiresAt: Date;
  createdAt: Date;
}
```

### Project Structure
[Source: architecture/unified-project-structure.md]

**Schema Location:** `src/lib/server/db/schema.ts`
**Types Location:** `src/lib/types/index.ts` (for shared TypeScript types)
**Migrations Location:** `drizzle/migrations/` (auto-generated)

### Coding Standards
[Source: architecture/coding-standards.md#naming-conventions]

**Naming Conventions:**
- Database Tables: snake_case (users, sessions)
- Database Columns: snake_case (user_id, created_at, expires_at)
- TypeScript Types: PascalCase (User, Session)
- TypeScript Fields: camelCase (userId, createdAt, expiresAt)

**Type Sharing Rule:**
- Always define types in `src/lib/types/` and import
- NEVER duplicate type definitions
- Export Drizzle-inferred types for database operations

### Migration Best Practices

**Migration Workflow:**
1. Update `src/lib/server/db/schema.ts`
2. Run `npm run db:generate` (or `drizzle-kit generate:pg`)
3. Review generated SQL in `drizzle/migrations/`
4. Run `npm run db:migrate` (or `drizzle-kit push:pg` for dev)
5. Verify schema with database client

**Migration Safety:**
- Always review generated SQL before running
- Test migrations on local database first
- Keep migration files in version control
- Never manually edit migration files after generation

### Schema Implementation Details

**Users Table Complete Definition:**
```typescript
export const users = pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  passwordHash: varchar('password_hash', { length: 255 }).notNull(), // Add per AC
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull()
}, (table) => ({
  emailIdx: index('users_email_idx').on(table.email)
}));
```

**Sessions Table Complete Definition:**
```typescript
export const sessions = pgTable('sessions', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  token: varchar('token', { length: 255 }).notNull().unique(),
  expiresAt: timestamp('expires_at').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull()
}, (table) => ({
  tokenIdx: index('sessions_token_idx').on(table.token)
}));
```

**Type Exports:**
```typescript
// Infer types from schema
export type User = typeof users.$inferSelect;
export type NewUser = typeof users.$inferInsert;
export type Session = typeof sessions.$inferSelect;
export type NewSession = typeof sessions.$inferInsert;
```

### Constraints and Indexes Summary

**Users Table:**
- Primary Key: id (UUID)
- Unique Constraint: email
- Index: email (for login queries)
- NOT NULL: id, email, password_hash, created_at, updated_at

**Sessions Table:**
- Primary Key: id (UUID)
- Unique Constraint: token
- Foreign Key: user_id → users.id (CASCADE DELETE)
- Index: token (for session validation queries)
- NOT NULL: id, user_id, token, expires_at, created_at

**Cascade Delete Behavior:**
When a user is deleted, all associated sessions are automatically deleted due to `onDelete: 'cascade'` constraint.

### Testing

**Testing Standards:**
[Source: architecture/tech-stack.md]

**Framework:** Vitest
**Test Location:** `tests/db/schema.test.ts`

**Test Requirements:**
1. **User Creation Test:**
   - Insert user with valid email and password_hash
   - Verify user is created with auto-generated UUID
   - Verify timestamps are auto-populated

2. **Email Uniqueness Test:**
   - Attempt to create two users with same email
   - Verify second insert fails with unique constraint error

3. **Session Creation Test:**
   - Create user, then create session for that user
   - Verify foreign key relationship works
   - Verify session token is unique

4. **Cascade Delete Test:**
   - Create user with multiple sessions
   - Delete user
   - Verify all sessions are automatically deleted

5. **Index Performance Test (optional):**
   - Verify indexes exist on email and token fields
   - Can query pg_indexes to confirm

**Testing Pattern:**
```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { db } from '$lib/server/db';
import { users, sessions } from '$lib/server/db/schema';
import { eq } from 'drizzle-orm';

describe('Database Schema', () => {
  // Setup/teardown for test data
  // Tests for each AC requirement
});
```

### Database Migration Verification

After running migration, verify with SQL:
```sql
-- Check users table
\d users

-- Check sessions table
\d sessions

-- Check indexes
\di users_email_idx
\di sessions_token_idx

-- Check foreign key constraints
SELECT * FROM information_schema.table_constraints
WHERE table_name IN ('users', 'sessions');
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929[1m])

### Debug Log References
No issues encountered during implementation.

### Completion Notes List
- Successfully implemented users and sessions tables with all required constraints
- Added password_hash field to users table as per acceptance criteria
- Created comprehensive unit tests with 11 test cases covering all requirements
- Migration generated and applied successfully: drizzle/migrations/0001_closed_barracuda.sql
- All tests passing (11/11)
- Database schema verified via psql: all indexes, constraints, and foreign keys confirmed

### File List
**Modified:**
- `src/lib/server/db/schema.ts` - Added password_hash to users, created sessions table, added indexes, exported types
- `package.json` - Added test scripts and vitest dependencies

**Created:**
- `tests/db/schema.test.ts` - Comprehensive schema unit tests (11 test cases)
- `tests/setup.ts` - Test environment configuration
- `vitest.config.ts` - Vitest test runner configuration
- `drizzle/migrations/0001_closed_barracuda.sql` - Database migration file

## QA Results

### Review Date: 2025-10-27

### Reviewed By: Quinn (Test Architect)

### Risk Assessment: DEEP REVIEW
**Triggers Met:**
- ✓ Auth/security files touched (password_hash, sessions table)
- ✓ Story has 6 acceptance criteria (threshold: >5)
- ✗ No issues with test count (11 tests present)
- ✗ Diff size reasonable

**Review Depth:** Comprehensive analysis including requirements traceability, NFR validation, and security review.

### Code Quality Assessment

**Overall: EXCELLENT** with minor improvements applied during review.

The implementation demonstrates strong engineering practices:
- Clean, well-structured Drizzle schema definitions
- Comprehensive test coverage (11 tests, 100% passing)
- Proper constraints and indexes implemented
- Good separation of concerns
- Clear documentation in code comments

**Strengths:**
- All 6 acceptance criteria fully implemented and tested
- Proper use of Drizzle ORM patterns (pgTable, indexes, foreign keys)
- Excellent cascade delete behavior for data integrity
- UUID usage prevents enumeration attacks
- Proper NOT NULL and UNIQUE constraints

**Areas Improved During Review:**
- Type exports now comply with coding standards
- Enhanced documentation with JSDoc comments

### Refactoring Performed

✓ **File: `src/lib/types/index.ts` (CREATED)**
  - **Change:** Created centralized types file with re-exports from schema
  - **Why:** Coding standard requires all types in `src/lib/types/` - original implementation exported directly from schema.ts
  - **How:** Re-exported User, NewUser, Session, NewSession types with JSDoc documentation for better discoverability

✓ **File: `src/lib/server/db/schema.ts`**
  - **Change:** Added JSDoc comments to all exported type definitions
  - **Why:** Improves maintainability and provides inline documentation for developers
  - **How:** Added descriptive comments explaining what each type represents and which fields are omitted

✓ **Verification:** All tests still passing (11/11) after refactoring

### Requirements Traceability

**AC1: Users table with required fields** → ✓ COVERED
- Test: `should create a user with valid data` (validates all fields)
- Test: `should auto-generate UUID for id field` (validates UUID generation)
- Test: `should auto-populate timestamps` (validates createdAt, updatedAt)
- Given: A new user with email and password_hash
- When: User is inserted into database
- Then: User is created with auto-generated UUID and timestamps

**AC2: Sessions table with required fields** → ✓ COVERED
- Test: `should create a session with valid data` (validates all fields)
- Test: `should enforce foreign key relationship to users` (validates userId reference)
- Test: `should cascade delete sessions when user is deleted` (validates cascade behavior)
- Test: `should auto-generate UUID for session id` (validates UUID generation)
- Given: A valid user and session data
- When: Session is inserted with userId reference
- Then: Session is created with proper foreign key relationship

**AC3: Database indexes on email and token** → ✓ COVERED
- Test: `should have index on users.email`
- Test: `should have index on sessions.token`
- Given: Migration has been applied
- When: Querying pg_indexes system table
- Then: Both indexes exist with correct names

**AC4: Drizzle schema types exported** → ✓ COVERED
- Verified: Lines 27-49 in schema.ts export User, NewUser, Session, NewSession
- Verified: TypeScript compilation succeeds (types are valid)
- Enhanced: Types now also re-exported from src/lib/types/index.ts per standards

**AC5: Migration script creates tables** → ✓ COVERED
- Verified: Migration file `0001_closed_barracuda.sql` exists and is correct
- Verified: All 11 tests pass against migrated database
- Tests implicitly verify tables exist and have correct schema

**AC6: Appropriate constraints** → ✓ COVERED
- Test: `should enforce email uniqueness constraint`
- Test: `should enforce token uniqueness constraint`
- Test: `should enforce foreign key relationship to users`
- NOT NULL constraints verified via test failures when required fields omitted
- Given: Duplicate or invalid data
- When: Attempting to insert/reference
- Then: Database enforces constraints with appropriate errors

**Coverage Analysis:** 6/6 ACs fully covered with comprehensive test scenarios

### Compliance Check

- **Coding Standards:** ✓ COMPLIANT (after refactoring)
  - ✓ Type sharing: Types now in src/lib/types/
  - ✓ Naming conventions: snake_case tables, camelCase TS fields, PascalCase types
  - ✓ Database queries: Schema uses Drizzle patterns correctly
  - ⚠️ Note: Story 1.1 db connection uses process.env directly (should use config objects)

- **Project Structure:** ✓ COMPLIANT
  - ✓ Schema location: `src/lib/server/db/schema.ts`
  - ✓ Types location: `src/lib/types/index.ts`
  - ✓ Migrations location: `drizzle/migrations/`
  - ✓ Tests location: `tests/db/schema.test.ts`

- **Testing Strategy:** ✓ EXCELLENT
  - ✓ Unit tests for all schema constraints
  - ✓ Tests verify indexes exist
  - ✓ Tests verify cascade behavior
  - ✓ Proper test cleanup with afterEach
  - ✓ Tests use realistic data patterns

- **All ACs Met:** ✓ YES (6/6 acceptance criteria fully implemented)

### Test Architecture Assessment

**Coverage:** EXCELLENT (11 tests covering all functional requirements)

**Test Level Appropriateness:** ✓ CORRECT
- Schema constraints → Unit tests (appropriate)
- Foreign key relationships → Unit tests (appropriate)
- Cascade delete → Integration-style unit test (appropriate)
- Index existence → Database verification test (appropriate)

**Test Design Quality:** EXCELLENT
- Clear test names describing scenarios
- Proper setup/teardown with beforeEach/afterEach
- Good use of test data (realistic emails, tokens)
- Tests are isolated and don't depend on each other
- UUID format validation uses proper regex

**Edge Case Coverage:** STRONG
- ✓ Duplicate email handling
- ✓ Duplicate token handling
- ✓ Foreign key violations
- ✓ Cascade delete behavior
- ⚠️ Missing: Password hash length validation (application layer concern)
- ⚠️ Missing: Session expiration edge cases (future story)

**Recommendations:**
- Consider adding test for extremely long token values (to validate 255 char limit)
- Future: Add integration tests when auth service is implemented

### Non-Functional Requirements (NFRs)

**Security: CONCERNS**
- ✓ Password stored as hash (not plaintext)
- ✓ UUID usage prevents user enumeration
- ✓ Foreign keys ensure referential integrity
- ✓ Unique constraints on email and token
- ⚠️ **CONCERN:** Token field limited to 255 chars may be insufficient
  - JWT tokens typically 200-400+ characters
  - Recommendation: Increase to `text` type or `varchar(512)`
- ⚠️ **INFO:** No rate limiting (handled at application layer, future story)

**Performance: PASS**
- ✓ Indexes on frequently-queried fields (email, token)
- ✓ Connection pooling configured (max 20 connections)
- ✓ Cascade delete prevents cleanup queries
- ✓ UUID v4 generation is efficient
- ✓ Timestamps use database defaults (no app overhead)

**Reliability: PASS**
- ✓ NOT NULL constraints on all required fields
- ✓ Unique constraints prevent duplicates
- ✓ Foreign key with CASCADE ensures data integrity
- ✓ All constraints tested and verified
- ✓ Error handling implicit in constraint violations

**Maintainability: PASS**
- ✓ Clean, readable code structure
- ✓ Good inline comments explaining purpose
- ✓ JSDoc documentation on exported types
- ✓ Consistent naming conventions
- ✓ Types properly exported and discoverable
- ✓ Migration files in version control

### Improvements Checklist

**Completed During Review:**
- [x] Created `src/lib/types/index.ts` to comply with type sharing standard
- [x] Added JSDoc comments to all exported types in schema.ts
- [x] Verified all tests pass after refactoring (11/11 passing)

**Recommended for Team (Not Blocking):**
- [ ] Consider increasing token field to `text` or `varchar(512)` for JWT support
- [ ] Add database trigger for automatic `updatedAt` field updates
- [ ] Use separate test database instead of main database
- [ ] Flag Story 1.1's `process.env` usage for refactoring (violates standards)
- [ ] Add test case for token length edge cases

### Security Review

**Overall Security Posture: STRONG** with one consideration

**Positive Security Practices:**
1. ✓ Password hash storage (never plaintext)
2. ✓ UUID primary keys prevent enumeration attacks
3. ✓ Foreign key constraints ensure data integrity
4. ✓ Unique constraints on authentication fields
5. ✓ Cascade delete prevents orphaned sensitive data

**Security Considerations:**
1. ⚠️ **Token Length:** 255-character limit may be insufficient for JWT tokens
   - **Impact:** Medium - Could cause runtime errors if JWT exceeds limit
   - **Likelihood:** Medium-High - JWTs with claims often exceed 255 chars
   - **Recommendation:** Change to `text` type or increase to `varchar(512)`
   - **Timeline:** Should be addressed before JWT implementation in auth service

2. ℹ️ **Architectural Conflict:** Story implements full password auth, but architecture says "email-only MVP"
   - **Impact:** None currently (flagged in Dev Notes)
   - **Action Required:** Product Owner should clarify auth approach

**No Critical Security Issues Found**

### Performance Considerations

**Overall Performance: OPTIMIZED**

**Strengths:**
- Indexes on email and token fields optimize login and session validation queries
- Connection pooling (max 20) prevents connection exhaustion
- UUID generation uses database default (no app overhead)
- Cascade delete prevents N+1 cleanup queries

**Future Optimizations (Not Needed Yet):**
- Session cleanup job for expired sessions (future story)
- Consider BTREE vs HASH index based on query patterns (current BTREE is appropriate)
- Monitor connection pool usage under load

### Technical Debt Identified

**Total Debt Score: LOW** (well-architected implementation)

1. **Token Field Length** - Priority: MEDIUM
   - Issue: 255 chars may be insufficient for JWT tokens
   - Effort: Low (schema change + migration)
   - Impact: Medium (could block JWT implementation)
   - Recommendation: Address before implementing auth service

2. **No updatedAt Trigger** - Priority: LOW
   - Issue: updatedAt must be manually set on updates
   - Effort: Low (add database trigger)
   - Impact: Low (prone to forgetting to update)
   - Recommendation: Add trigger in future schema story

3. **Test Database Separation** - Priority: LOW
   - Issue: Tests run against main database
   - Effort: Low (add test DB config)
   - Impact: Low (could interfere with dev data)
   - Recommendation: Add in Epic 2 when more complex tests exist

4. **Story 1.1 Config Issue (OUT OF SCOPE)** - Priority: HIGH
   - Issue: DB connection uses `process.env` directly (violates standards)
   - Effort: Medium (create config service)
   - Impact: High (maintainability, testability)
   - Recommendation: Flag to team for separate refactoring story

### Files Modified During Review

**Created:**
- `src/lib/types/index.ts` - Centralized type exports per coding standards

**Modified:**
- `src/lib/server/db/schema.ts` - Added JSDoc documentation to type exports

**Note:** Please update the File List section to include `src/lib/types/index.ts` as a created file.

### Gate Status

**Gate: CONCERNS** → `docs/qa/gates/1.2-user-database-schema.yml`

**Status Reason:** Excellent implementation with comprehensive tests. Minor concern regarding token field length (255 chars may be insufficient for JWT tokens). Recommend increasing before implementing auth service. Refactoring completed to ensure coding standards compliance.

**Quality Score:** 80/100
- Base: 100
- Concerns: -20 (2 medium issues × 10 points each)
- Final: 80

**Evidence:**
- Tests Reviewed: 11 (all passing)
- Risks Identified: 2 medium concerns
- AC Coverage: 6/6 fully covered
- NFR Status: Security CONCERNS, Performance PASS, Reliability PASS, Maintainability PASS

### Recommended Status

**✓ APPROVED for Done** (with advisory note)

**Rationale:**
- All acceptance criteria fully met and tested
- Code quality is excellent
- Refactoring completed during review
- Token length concern is advisory, not blocking
- Can be addressed in future story before auth implementation

**Advisory Note:** Consider addressing token field length before implementing JWT-based authentication in Epic 2. This is a preventive recommendation, not a blocker for marking this story as Done.

**Story Team Decision:** Final status change is at story owner's discretion. This review recommends proceeding to Done with the noted advisory.
