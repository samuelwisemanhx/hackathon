# Story 1.1: Project Setup and Database Configuration

## Status
Draft

## Story
**As a** developer,
**I want** the SvelteKit 5 project initialized with PostgreSQL and Drizzle ORM configured,
**so that** I have a working development environment with database connectivity.

## Acceptance Criteria

1. SvelteKit 5 project is initialized with TypeScript support and recommended project structure
2. PostgreSQL database is configured for both local development and production environments
3. Drizzle ORM is installed and configured with connection pooling
4. Drizzle Kit is set up for schema migrations with initial migration created
5. Environment variables are properly configured (.env.example provided, .env in .gitignore)
6. Database connection is verified with a simple health check
7. Development server runs without errors on `npm run dev`
8. README contains setup instructions for local development

## Tasks / Subtasks

- [ ] Initialize SvelteKit 5 project with TypeScript (AC: 1, 7)
  - [ ] Run `npm create svelte@latest .` with TypeScript and recommended options
  - [ ] Verify project structure matches architecture documentation
  - [ ] Install base dependencies
  - [ ] Verify dev server starts with `npm run dev`

- [ ] Install and configure PostgreSQL dependencies (AC: 2, 3)
  - [ ] Install `pg` (PostgreSQL client) and Drizzle ORM packages
  - [ ] Install Drizzle Kit for migrations
  - [ ] Install necessary TypeScript type definitions

- [ ] Create database configuration files (AC: 3, 4)
  - [ ] Create `src/lib/server/db/schema.ts` with initial empty schema
  - [ ] Create `src/lib/server/db/index.ts` with connection pool configuration
  - [ ] Create `drizzle.config.ts` at project root for Drizzle Kit configuration
  - [ ] Verify Drizzle Kit can read configuration

- [ ] Configure environment variables (AC: 5)
  - [ ] Create `.env.example` with all required database variables (DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD)
  - [ ] Verify `.env` is in `.gitignore`
  - [ ] Document environment variable purpose and example values

- [ ] Set up local PostgreSQL database (AC: 2, 4)
  - [ ] Create local PostgreSQL database matching DB_NAME
  - [ ] Run initial Drizzle migration to verify connection
  - [ ] Verify tables can be created successfully

- [ ] Create database health check endpoint (AC: 6)
  - [ ] Create `/api/health` route in `src/routes/api/health/+server.ts`
  - [ ] Implement simple query to verify database connectivity
  - [ ] Return JSON response with status and timestamp
  - [ ] Test health check endpoint returns 200 OK

- [ ] Write comprehensive README (AC: 8)
  - [ ] Document prerequisites (Node.js, PostgreSQL)
  - [ ] Document local setup steps
  - [ ] Document how to configure environment variables
  - [ ] Document how to run database migrations
  - [ ] Document how to start development server
  - [ ] Include troubleshooting section

- [ ] Verify complete setup (AC: 1-8)
  - [ ] Run through full setup process from scratch
  - [ ] Verify all acceptance criteria are met
  - [ ] Test health check endpoint
  - [ ] Verify no errors in dev server console

## Dev Notes

### Previous Story Insights
No previous story - this is the foundation story.

### Tech Stack Requirements
[Source: architecture/tech-stack.md]

**Critical Technology Versions:**
- Frontend Framework: SvelteKit 2.x (with Svelte 5)
- Language: TypeScript 5.x
- Database: PostgreSQL 15.x+
- ORM: Drizzle ORM (latest)
- Build Tool: Vite 5.x (built into SvelteKit)

**Required Dependencies:**
- `@sveltejs/kit` - Core framework
- `svelte` - Reactive framework
- `typescript` - Type-safe development
- `pg` - PostgreSQL client for Node.js
- `drizzle-orm` - Type-safe ORM
- `drizzle-kit` - Migration and introspection tool
- `@types/pg` - TypeScript definitions for pg

### Project Structure
[Source: architecture/unified-project-structure.md]

**Key Directories to Create:**
```
src/
├── lib/
│   ├── server/
│   │   ├── db/
│   │   │   ├── schema.ts     # Drizzle schema definitions
│   │   │   └── index.ts      # DB connection pool
│   ├── types/
│   │   └── index.ts          # Shared TypeScript types
│   └── utils/
├── routes/
│   ├── +layout.svelte
│   ├── +page.svelte
│   └── api/
│       └── health/           # Health check endpoint
```

### Database Configuration Details
[Source: architecture/database-schema.md#database-configuration]

**Connection Pool Configuration:**
```typescript
// src/lib/server/db/index.ts
import { drizzle } from 'drizzle-orm/node-postgres';
import { Pool } from 'pg';
import * as schema from './schema';

const pool = new Pool({
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '5432'),
  database: process.env.DB_NAME || 'ai_assessment',
  user: process.env.DB_USER || 'postgres',
  password: process.env.DB_PASSWORD,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

export const db = drizzle(pool, { schema });
```

**Initial Schema File:**
```typescript
// src/lib/server/db/schema.ts
// Empty for now - will be populated in Story 1.2
export {};
```

**Drizzle Config:**
```typescript
// drizzle.config.ts
import type { Config } from 'drizzle-kit';

export default {
  schema: './src/lib/server/db/schema.ts',
  out: './drizzle/migrations',
  driver: 'pg',
  dbCredentials: {
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT || '5432'),
    database: process.env.DB_NAME || 'ai_assessment',
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || '',
  },
} satisfies Config;
```

### Environment Variables
[Source: architecture/database-schema.md#database-configuration]

**Required Variables (.env.example):**
```
# Database Configuration
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ai_assessment
DB_USER=postgres
DB_PASSWORD=your_password_here
```

### Health Check Implementation
[Source: architecture/coding-standards.md#critical-fullstack-rules]

**API Route Pattern:**
- All API routes must use try-catch
- Return format: `{error: {code, message, details}}` for errors
- Success format: JSON with appropriate data

**Health Check Example:**
```typescript
// src/routes/api/health/+server.ts
import { json } from '@sveltejs/kit';
import { db } from '$lib/server/db';
import { sql } from 'drizzle-orm';

export async function GET() {
  try {
    // Simple query to verify DB connection
    await db.execute(sql`SELECT 1`);

    return json({
      status: 'ok',
      timestamp: new Date().toISOString(),
      database: 'connected'
    });
  } catch (error) {
    return json({
      error: {
        code: 'DATABASE_ERROR',
        message: 'Database connection failed',
        details: error instanceof Error ? error.message : 'Unknown error'
      }
    }, { status: 500 });
  }
}
```

### Coding Standards to Follow
[Source: architecture/coding-standards.md]

**Critical Rules:**
- Environment Variables: Access only through validated config objects - NEVER use `process.env` directly in application code (config files are exception)
- Error Handling: All API routes must use try-catch and return proper error format
- Naming Conventions:
  - API Routes: kebab-case (e.g., `/api/health`)
  - Database Tables: snake_case
  - Functions: camelCase
  - Types: PascalCase

### Testing

**Testing Standards:**
[Source: architecture/tech-stack.md]

**Framework:** Vitest (latest version)
- Native Vite integration
- Fast execution
- Compatible with SvelteKit
- TypeScript support

**Test Location:**
- Tests should be created in `tests/` directory at project root
- For this story: Create `tests/api/health.test.ts` to verify health check endpoint

**Test Requirements for This Story:**
- Unit test for health check endpoint
- Verify successful database connection returns 200 status
- Verify database connection failure returns 500 status with proper error format
- Mock database connection for testing

**Testing Pattern:**
```typescript
// tests/api/health.test.ts
import { describe, it, expect, vi } from 'vitest';
// Test implementation will verify health endpoint behavior
```

### Project Structure Notes

The project structure MUST follow the unified structure defined in `architecture/unified-project-structure.md`. Key alignment points:
- All server-side code in `src/lib/server/`
- Database code specifically in `src/lib/server/db/`
- API routes in `src/routes/api/`
- Configuration files at project root
- Migrations generated in `drizzle/migrations/`

### Setup Verification Checklist

Before marking story complete, verify:
1. `npm run dev` starts without errors
2. Health check endpoint `/api/health` returns 200 OK
3. Database connection pool is configured correctly
4. All environment variables documented in .env.example
5. README includes complete setup instructions
6. TypeScript compilation has no errors
7. Drizzle Kit can generate migrations
8. Project structure matches architecture documentation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
