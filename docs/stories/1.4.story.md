# Story 1.4: User Login and Session Management

## Status
Draft

## Story
**As a** registered user,
**I want** to log in with my email and password,
**so that** I can access my account and assessments.

## Acceptance Criteria

1. POST `/api/auth/login` endpoint accepts email and password
2. Credentials are validated against stored user record
3. Successful login creates session token and stores in sessions table
4. Session token is returned via secure HTTP-only cookie with appropriate expiration
5. Failed login returns appropriate error (401) without revealing whether email exists
6. POST `/api/auth/logout` endpoint clears session token and invalidates session in database
7. Session middleware validates session token on protected routes
8. Integration tests cover complete login/logout flow

## Tasks / Subtasks

- [ ] Create login API endpoint (AC: 1, 2, 3, 4, 5)
  - [ ] Create `src/routes/api/auth/login/+server.ts`
  - [ ] Implement request validation (email + password)
  - [ ] Query user by email
  - [ ] Verify password using bcrypt.compare()
  - [ ] Generate secure session token (crypto.randomBytes)
  - [ ] Store session in database with expiration
  - [ ] Set HTTP-only cookie with session token
  - [ ] Return 401 for invalid credentials (generic message)

- [ ] Create logout API endpoint (AC: 6)
  - [ ] Create `src/routes/api/auth/logout/+server.ts`
  - [ ] Delete session from database
  - [ ] Clear session cookie
  - [ ] Return success response

- [ ] Create session middleware (AC: 7)
  - [ ] Create `src/hooks.server.ts` with handle function
  - [ ] Read session token from cookie
  - [ ] Validate session exists and not expired
  - [ ] Load user data into event.locals
  - [ ] Allow public routes (/api/auth/*, /, /register, /login)

- [ ] Create session repository functions
  - [ ] createSession(userId, token, expiresAt)
  - [ ] findSessionByToken(token)
  - [ ] deleteSession(token)
  - [ ] deleteExpiredSessions() for cleanup

- [ ] Write comprehensive tests (AC: 8)
  - [ ] Test successful login flow
  - [ ] Test invalid email returns 401
  - [ ] Test invalid password returns 401
  - [ ] Test session cookie is set correctly
  - [ ] Test session stored in database
  - [ ] Test logout clears session
  - [ ] Test middleware validates sessions
  - [ ] Test middleware blocks unauthenticated access

## Dev Notes

### CRITICAL: Same Architectural Conflict as Story 1.3

**⚠️** Architecture specifies email-only MVP auth (no passwords, no sessions), but epic requires traditional session-based auth. **Implement per epic AC** as explained in Story 1.3.

### Previous Story Insights
[Source: Story 1.2, 1.3]
- Users table has password_hash field
- Sessions table created with user_id, token, expires_at
- Password hashing uses bcrypt
- User repository has findUserByEmail() function

### Session Token Generation

**Secure Random Token:**
```typescript
import crypto from 'crypto';

function generateSessionToken(): string {
  return crypto.randomBytes(32).toString('hex'); // 64 character hex string
}
```

### Session Expiration

**Recommended:** 7 days for web app
```typescript
const SEESSION_DURATION_MS = 7 * 24 * 60 * 60 * 1000; // 7 days
const expiresAt = new Date(Date.now() + SESSION_DURATION_MS);
```

### Login Endpoint Implementation
[Source: architecture/coding-standards.md]

```typescript
// src/routes/api/auth/login/+server.ts
import { json } from '@sveltejs/kit';
import { z } from 'zod';
import bcrypt from 'bcrypt';
import crypto from 'crypto';
import { findUserByEmail } from '$lib/server/repositories/user';
import { createSession } from '$lib/server/repositories/session';
import type { RequestHandler } from './$types';

const loginSchema = z.object({
  email: z.string().email(),
  password: z.string().min(1)
});

export const POST: RequestHandler = async ({ request, cookies }) => {
  try {
    const body = await request.json();
    const { email, password } = loginSchema.parse(body);

    const user = await findUserByEmail(email);
    if (!user) {
      return json({
        error: {
          code: 'INVALID_CREDENTIALS',
          message: 'Invalid email or password',
          details: {}
        }
      }, { status: 401 });
    }

    const validPassword = await bcrypt.compare(password, user.passwordHash);
    if (!validPassword) {
      return json({
        error: {
          code: 'INVALID_CREDENTIALS',
          message: 'Invalid email or password',
          details: {}
        }
      }, { status: 401 });
    }

    // Create session
    const token = crypto.randomBytes(32).toString('hex');
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
    await createSession(user.id, token, expiresAt);

    // Set HTTP-only cookie
    cookies.set('session_token', token, {
      path: '/',
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      expires: expiresAt
    });

    return json({
      user: {
        id: user.id,
        email: user.email
      }
    });
  } catch (error) {
    return json({
      error: {
        code: 'INTERNAL_ERROR',
        message: 'Login failed',
        details: error instanceof Error ? error.message : 'Unknown error'
      }
    }, { status: 500 });
  }
};
```

### Session Middleware
[Source: architecture/unified-project-structure.md]

**File:** `src/hooks.server.ts`

```typescript
import type { Handle } from '@sveltejs/kit';
import { findSessionByToken } from '$lib/server/repositories/session';
import { findUserById } from '$lib/server/repositories/user';

export const handle: Handle = async ({ event, resolve }) => {
  const token = event.cookies.get('session_token');

  if (token) {
    const session = await findSessionByToken(token);

    if (session && session.expiresAt > new Date()) {
      const user = await findUserById(session.userId);
      if (user) {
        event.locals.user = user;
        event.locals.session = session;
      }
    }
  }

  // Check protected routes
  const path = event.url.pathname;
  const publicPaths = ['/', '/login', '/register', '/api/auth/login', '/api/auth/register'];

  if (!event.locals.user && !publicPaths.includes(path) && !path.startsWith('/api/auth/')) {
    return new Response('Redirect', {
      status: 303,
      headers: { Location: '/login' }
    });
  }

  return resolve(event);
};
```

### Session Repository
[Source: architecture/unified-project-structure.md]

**File:** `src/lib/server/repositories/session.ts`

```typescript
import { db } from '$lib/server/db';
import { sessions } from '$lib/server/db/schema';
import { eq } from 'drizzle-orm';

export async function createSession(userId: string, token: string, expiresAt: Date) {
  const [session] = await db.insert(sessions).values({
    userId,
    token,
    expiresAt
  }).returning();
  return session;
}

export async function findSessionByToken(token: string) {
  const [session] = await db.select().from(sessions).where(eq(sessions.token, token));
  return session;
}

export async function deleteSession(token: string) {
  await db.delete(sessions).where(eq(sessions.token, token));
}
```

### App Type Definitions

**File:** `src/app.d.ts`

```typescript
import type { User, Session } from '$lib/types';

declare global {
  namespace App {
    interface Locals {
      user?: User;
      session?: Session;
    }
  }
}

export {};
```

### Security Considerations

**HTTP-only Cookies:** Prevent XSS attacks by making cookies inaccessible to JavaScript
**Secure Flag:** Only transmit over HTTPS in production
**SameSite:** Prevent CSRF attacks
**Generic Error Messages:** Don't reveal if email exists (security best practice)

### Testing
[Source: architecture/tech-stack.md]

**Test Files:**
- `tests/api/auth/login.test.ts`
- `tests/api/auth/logout.test.ts`
- `tests/middleware/auth.test.ts`

**Key Test Scenarios:**
- Successful login sets cookie and creates session
- Invalid credentials return 401
- Session middleware loads user data
- Protected routes redirect unauthenticated users
- Logout clears session

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
